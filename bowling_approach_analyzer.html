<!DOCTYPE html>
<html lang="en">
<head>    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BowlBetter!</title>
    <style>
        :root {
            --primary: #00bfff;
            --primary-dark: #007bff;
            --background: #181c24;
            --surface: #232837;
            --surface-alt: #232837;
            --text: #e6e6e6;
            --text-muted: #b0b8c1;
            --accent: #ffb300;
            --border: #2c3242;
            --shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        html, body {
            background: var(--background);
            color: var(--text);
        }
        body {
            font-family: 'Segoe UI', 'Arial', sans-serif;
            margin: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            background: var(--surface);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 800px;
        }
        h1, h2, h3 {
            color: var(--primary);
        }
        h2 {
            margin-top: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--accent);
        }
        input[type="number"],
        input[type="file"],
        input[type="text"],
        button,
        select {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: var(--surface-alt);
            color: var(--text);
            width: calc(100% - 22px);
        }
        input[type="file"] {
            color-scheme: dark;
        }
        #apiKey {
            width: calc(100% - 22px);
            margin-bottom: 10px;
        }
        button {
            background: var(--primary-dark);
            color: #fff;
            cursor: pointer;
            border: none;
            transition: background 0.2s;
        }
        button:hover {
            background: var(--primary);
        }
        .tab-container {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: var(--surface-alt);
            border: 1px solid var(--border);
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background: var(--surface);
            border-bottom-color: var(--surface);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #imageUploadContainer {
            margin-top: 15px;
        }
        .image-upload-step {
            border: 1px solid var(--border);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            background: var(--surface-alt);
        }
        .step-heading {
            margin-top: 0;
            color: var(--primary);
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid var(--border);
            background: #232837cc;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
            min-height: 100px;
            color: var(--text);
        }
        .spinner {
            border: 4px solid #232837;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .preview-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: #181c24;
        }
        .step-analysis {
            margin-top: 10px;
            padding: 10px;
            background: #1e2330;
            border-radius: 4px;
            border-left: 3px solid var(--primary);
            color: var(--text);
        }
        .auto-detect-container {
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: 4px;
            background: var(--surface-alt);
            margin-bottom: 20px;
        }
        .detected-step {
            border: 1px solid #2ecc40;
            background: #1e2b1e;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .step-images {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .drag-area {
            border: 2px dashed var(--primary);
            padding: 30px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
            background: #232837;
            position: relative;
        }
        .drag-area.active {
            border-color: #28a745;
            background: #1e2b1e;
        }
        .file-details {
            margin-top: 15px;
            padding: 10px;
            background: #232837;
            border-radius: 4px;
            text-align: left;
        }
        .drop-instruction {
            font-size: 18px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }
        .or-divider {
            display: flex;
            align-items: center;
            margin: 15px 0;
            color: var(--text-muted);
        }
        .or-divider:before, .or-divider:after {
            content: "";
            flex-grow: 1;
            background: var(--border);
            height: 1px;
            margin: 0 10px;
        }
        .optimization-controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #232837;
            border: 1px solid var(--border);
            border-radius: 4px;
        }
        .optimization-controls select {
            margin-bottom: 10px;
            padding: 8px;
            width: 100%;
        }
        #samplingControls {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }
        .tooltip-wrapper {
            display: inline-block;
            position: relative;
            margin-left: 5px;
        }
        .tooltip-icon {
            cursor: help;
            color: var(--primary);
        }
        .tooltip-text {
            display: none;
            position: absolute;
            background: #232837;
            color: var(--text);
            padding: 5px 10px;
            border-radius: 4px;
            width: 200px;
            top: 20px;
            left: -100px;
            z-index: 1;
            font-size: 12px;
        }
        .tooltip-wrapper:hover .tooltip-text {
            display: block;
        }
        .processing-status {
            margin: 20px 0;
            padding: 15px;
            background: #1e2330;
            border: 1px solid #2c3242;
            border-radius: 4px;
        }
        .progress-bar-container {
            height: 20px;
            background: #232837;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }
        #processing-details {
            margin-bottom: 10px;
            font-size: 14px;
        }
        #processing-stats {
            font-size: 14px;
            color: var(--text-muted);
        }
        .video-controls {
            margin-top: 15px;
            padding: 15px;
            background: #1e2330;
            border: 1px solid #2c3242;
            border-radius: 4px;
        }
        .video-preview {
            margin-top: 10px;
            max-width: 100%;
            border-radius: 4px;
            border: 1px solid var(--border);
        }
        .frame-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .frame-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: #181c24;
        }
        .captured-frame {
            position: relative;
            margin-bottom: 15px;
            display: inline-block;
        }
        .time-label {
            font-size: 12px;
            text-align: center;
            margin-top: 5px;
            color: var(--text-muted);
        }
        .remove-frame {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #dc3545;
            color: white;
            border: none;
            padding: 0;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .frame-analysis {
            margin-bottom: 20px;
            padding: 15px;
            background: #232837;
            border-radius: 4px;
            border-left: 3px solid var(--primary);
        }
        #selected-frames-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        .selected-frame {
            border: 2px solid var(--primary);
        }
        .time-display {
            font-size: 14px;
            color: var(--text);
            margin-bottom: 10px;
        }
        .scrubber-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .scrubber-buttons button {
            flex: 1;
        }
        .step-tab-content {
            display: none;
        }
        .step-tab-content.active {
            display: block;
        }
        .step-tab-btn {
            padding: 10px 15px;
            cursor: pointer;
            background: #232837;
            border: 1px solid var(--border);
            border-radius: 4px;
            margin-right: 5px;
            flex: none;
            color: var(--text);
        }
        .step-tab-btn.active {
            background: var(--primary-dark);
            color: #fff;
            border-color: var(--primary-dark);
        }
        #stepTabsContainer {
            margin-top: 20px;
            display: none;
        }
        .bulk-upload-container {
            background: #1e2330;
            border: 1px solid #2c3242;
            border-radius: 6px;
            padding: 18px 18px 10px 18px;
            margin-bottom: 18px;
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            box-shadow: 0 2px 8px rgba(0,123,255,0.06);
        }
        .bulk-upload-label {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            font-size: 1.08em;
        }
        .bulk-upload-icon {
            font-size: 1.5em;
            margin-right: 8px;
        }
        .bulk-upload-input {
            margin-bottom: 8px;
            border: 1px solid #2c3242;
            border-radius: 4px;
            padding: 8px;
            background: #232837;
            color: var(--text);
            width: 100%;
            max-width: 350px;
            font-size: 1em;
        }
        .bulk-upload-hint {
            font-size: 0.97em;
            color: var(--text-muted);
            margin-top: 2px;
            margin-bottom: 0;
            opacity: 0.85;
        }
        .toggle-api-key-btn {
            position: absolute;
            right: 10px;
            top: 34px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            color: var(--primary);
            padding: 0 4px;
            z-index: 2;
        }
        .toggle-api-key-btn:focus {
            outline: 2px solid var(--primary);
        }
        .app-header {
            text-align: center;
            margin-bottom: 18px;
        }
        .app-header h1 {
            font-size: 2.3em;
            color: var(--primary);
            margin-bottom: 2px;
            letter-spacing: 1px;
        }
        .header-meta {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            margin-bottom: 6px;
        }
        .author {
            font-size: 0.98em;
            color: var(--text-muted);
            opacity: 0.85;
            margin-bottom: 2px;
        }
        .powered-by-groq {
            font-size: 0.95em;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .groq-logo {
            height: 22px;
            vertical-align: middle;
            margin-left: 3px;
        }
        .groq-link {
            display: inline-block;
            vertical-align: middle;
        }
        /* Fun SVG art for the header */
        .bowling-svg-art {
            display: block;
            margin: 0 auto 18px auto;
            max-width: 180px;
        }
        .get-api-key-container {
            margin-bottom: 18px;
            text-align: left;
        }
        .api-key-instructions-btn {
            background: var(--primary-dark);
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 8px 18px;
            font-size: 1em;
            cursor: pointer;
            margin-bottom: 8px;
            transition: background 0.2s;
        }
        .api-key-instructions-btn:hover {
            background: var(--primary);
        }
        .api-key-instructions {
            background: #1e2330;
            border: 1px solid #2c3242;
            border-radius: 6px;
            padding: 16px 18px;
            margin-top: 8px;
            color: var(--text);
            font-size: 1em;
        }
        .api-key-instructions h3 {
            color: var(--primary);
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.15em;
        }
        .api-key-instructions a {
            color: var(--accent);
            text-decoration: underline;
        }
        .api-key-instructions ol {
            margin-left: 18px;
            margin-bottom: 8px;
        }
        /* --- Remove all inline styles and add CSS classes for layout polish --- */
.api-key-row {
    position: relative;
    margin-bottom: 18px;
}
.flex-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
}
.flex-row .flex-btn {
    flex: 1;
    margin: 0 2px;
    min-width: 0;
}
#stepTabsNav {
    display: flex;
    overflow-x: auto;
    gap: 6px;
    margin-bottom: 10px;
}
.mt-20 {
    margin-top: 20px;
}
        /* Responsive for mobile */
@media (max-width: 600px) {
    .container {
        padding: 8px;
        border-radius: 0;
        width: 100vw;
        min-width: 0;
        box-shadow: none;
    }
    .app-header h1 {
        font-size: 1.5em;
    }
    .bowling-svg-art {
        max-width: 120px;
    }
    .step-tab-btn {
        padding: 7px 8px;
        font-size: 0.95em;
    }
    .bulk-upload-container {
        padding: 10px 6px 6px 6px;
    }
    .api-key-instructions {
        padding: 10px 6px;
    }
}
    </style>
</head>
<body>    <div class="container">
        <header class="app-header">
            <svg class="bowling-svg-art" viewBox="0 0 180 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                <ellipse cx="40" cy="40" rx="18" ry="18" fill="#fff" stroke="#007bff" stroke-width="3"/>
                <ellipse cx="140" cy="40" rx="18" ry="18" fill="#fff" stroke="#007bff" stroke-width="3"/>
                <ellipse cx="90" cy="40" rx="18" ry="18" fill="#fff" stroke="#007bff" stroke-width="3"/>
                <rect x="80" y="10" width="20" height="40" rx="10" fill="#ffb300" stroke="#007bff" stroke-width="2"/>
                <circle cx="90" cy="30" r="3" fill="#007bff"/>
                <circle cx="90" cy="40" r="3" fill="#007bff"/>
                <circle cx="90" cy="50" r="3" fill="#007bff"/>
                <ellipse cx="40" cy="40" rx="7" ry="7" fill="#007bff" opacity="0.15"/>
                <ellipse cx="140" cy="40" rx="7" ry="7" fill="#007bff" opacity="0.15"/>
                <ellipse cx="90" cy="40" rx="7" ry="7" fill="#007bff" opacity="0.15"/>
                <text x="90" y="20" text-anchor="middle" fill="#ffb300" font-size="12" font-family="Segoe UI, Arial, sans-serif">BowlBetter!</text>
            </svg>
            <h1>BowlBetter!</h1>
            <div class="header-meta">
                <span class="author">J.D.Dondlinger</span>
                <span class="powered-by-groq">
                    Powered by
                    <a href="https://groq.com" target="_blank" rel="noopener noreferrer" class="groq-link">
                        <img src="https://groq.com/wp-content/uploads/2024/03/PBG-mark1-color.svg" alt="Powered by Groq for fast inference." class="groq-logo"/>
                    </a>
                </span>
            </div>
        </header>
        <div class="get-api-key-container">
            <button id="showApiKeyInstructionsBtn" class="api-key-instructions-btn">How to get Groq API Key?</button>
            <div id="apiKeyInstructions" class="api-key-instructions" hidden>
                <h3>How to Get Your Groq API Key</h3>
                <ol>
                    <li>Go to <a href="https://console.groq.com/keys" target="_blank" rel="noopener noreferrer">Groq Console API Keys</a>.</li>
                    <li>Sign in or create a free Groq account.</li>
                    <li>Click <strong>"Create API Key"</strong> and give it a name (e.g., "BowlBetter!").</li>
                    <li>Copy your new API key and paste it into the field above.</li>
                    <li>Keep your API key private! Do not share it with others.</li>
                </ol>
                <p>For more details, see the <a href="https://console.groq.com/docs/quickstart" target="_blank" rel="noopener noreferrer">Groq Quickstart Guide</a>.</p>
            </div>
        </div>
        <div class="api-key-row">
            <label for="apiKey">Groq API Key:</label>
            <input type="text" id="apiKey" placeholder="Enter your Groq API Key here">
            <button type="button" id="toggleApiKeyBtn" class="toggle-api-key-btn" aria-label="Show/Hide API Key">👁️</button>
        </div>
        <div>
            <label for="stepCount">Number of steps in your bowling approach:</label>
            <input type="number" id="stepCount" min="1" max="10" value="4">
            <button onclick="generateStepTabs()">Set Steps</button>
        </div>
        <div class="bulk-upload-container">
            <label for="bulkImageUpload" class="bulk-upload-label">
                <span class="bulk-upload-icon">📥</span> Upload all step images at once:
            </label>
            <input type="file" id="bulkImageUpload" accept="image/*" multiple class="bulk-upload-input">
            <div class="bulk-upload-hint">Tip: Select all your step images in order (hold Ctrl or Shift) and they will be assigned automatically.</div>
        </div>
        <div id="stepTabsContainer">
            <div id="stepTabsNav"></div>
            <div id="stepTabContent"></div>
            <div class="flex-row">
                <button id="prevStepBtn" onclick="showStepTab(currentStepTab-1)" class="flex-btn">Previous</button>
                <button id="nextStepBtn" onclick="showStepTab(currentStepTab+1)" class="flex-btn">Next</button>
            </div>
        </div>
        <div class="mt-20">
            <button id="analyzeButton" onclick="analyzeApproach()" disabled>Analyze Bowling Approach</button>
        </div>
        <div class="spinner" id="spinner"></div>
        <h2>Analysis Results:</h2>
        <div id="result"></div>
    </div>

    <script>
        let currentStepTab = 1;
        let totalSteps = 4;

        // Generate step tabs for each bowling step
        function generateStepTabs() {
            totalSteps = parseInt(document.getElementById('stepCount').value);
            if (isNaN(totalSteps) || totalSteps < 1 || totalSteps > 10) {
                alert('Please enter a valid number of steps (1-10)');
                return;
            }
            const nav = document.getElementById('stepTabsNav');
            const content = document.getElementById('stepTabContent');
            nav.innerHTML = '';
            content.innerHTML = '';
            for (let i = 1; i <= totalSteps; i++) {
                const tabBtn = document.createElement('button');
                tabBtn.textContent = `Step ${i}`;
                tabBtn.className = 'step-tab-btn';
                tabBtn.onclick = () => showStepTab(i);
                nav.appendChild(tabBtn);

                const tabDiv = document.createElement('div');
                tabDiv.id = `stepTab${i}`;
                tabDiv.className = 'step-tab-content';
                tabDiv.style.display = i === 1 ? 'block' : 'none';
                tabDiv.innerHTML = `
                    <h3>Step ${i}</h3>
                    <label for="imageFile${i}">Upload image for Step ${i}:</label>
                    <input type="file" id="imageFile${i}" accept="image/*" class="step-image-input" onchange="previewImage(this, ${i}); checkAllImagesUploaded();">
                    <div id="previewContainer${i}" class="preview-container"></div>
                    <div id="stepAnalysis${i}" class="step-analysis" style="display:none;"></div>
                `;
                content.appendChild(tabDiv);
            }
            document.getElementById('stepTabsContainer').style.display = 'block';
            currentStepTab = 1;
            updateStepTabNav();
            showStepTab(1);
            document.getElementById('analyzeButton').disabled = true;
            attachSwipeListeners(); // <-- add swipe listeners
        }

        // Show the specified step tab
        function showStepTab(n) {
            if (n < 1 || n > totalSteps) return;
            for (let i = 1; i <= totalSteps; i++) {
                document.getElementById(`stepTab${i}`).style.display = (i === n) ? 'block' : 'none';
            }
            currentStepTab = n;
            updateStepTabNav();
        }

        // Update the navigation buttons and tab styles
        function updateStepTabNav() {
            const navBtns = document.querySelectorAll('.step-tab-btn');
            navBtns.forEach((btn, idx) => {
                btn.style.background = (idx+1 === currentStepTab) ? '#007bff' : '#f1f1f1';
                btn.style.color = (idx+1 === currentStepTab) ? '#fff' : '#333';
                btn.style.border = '1px solid #007bff';
                btn.style.borderRadius = '4px';
                btn.style.padding = '8px 12px';
                btn.style.minWidth = '60px';
                btn.style.flex = 'none';
            });
            document.getElementById('prevStepBtn').disabled = (currentStepTab === 1);
            document.getElementById('nextStepBtn').disabled = (currentStepTab === totalSteps);
        }

        // Preview uploaded image
        function previewImage(input, stepNumber) {
            const previewContainer = document.getElementById(`previewContainer${stepNumber}`);
            previewContainer.innerHTML = '';
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-image';
                    img.alt = `Step ${stepNumber} preview`;
                    previewContainer.appendChild(img);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Enable analyze button only when all images are uploaded
        function checkAllImagesUploaded() {
            let allUploaded = true;
            for (let i = 1; i <= totalSteps; i++) {
                const fileInput = document.getElementById(`imageFile${i}`);
                if (!fileInput.files || !fileInput.files[0]) {
                    allUploaded = false;
                    break;
                }
            }
            document.getElementById('analyzeButton').disabled = !allUploaded;
        }

        // Analyze all images in the bowling approach
        async function analyzeApproach() {
            const apiKey = document.getElementById('apiKey').value;
            const resultDiv = document.getElementById('result');
            const spinner = document.getElementById('spinner');
            if (!apiKey) {
                resultDiv.textContent = 'Please enter your Groq API Key.';
                return;
            }
            let hasAllImages = true;
            const imageFiles = [];
            for (let i = 1; i <= totalSteps; i++) {
                const fileInput = document.getElementById(`imageFile${i}`);
                if (!fileInput.files || !fileInput.files[0]) {
                    hasAllImages = false;
                    resultDiv.textContent = `Please upload an image for Step ${i}.`;
                    break;
                }
                imageFiles.push({ stepNumber: i, file: fileInput.files[0] });
            }
            if (!hasAllImages) return;
            resultDiv.textContent = '';
            spinner.style.display = 'block';
            try {
                // Analyze each step individually
                const analyses = await analyzeSteps(apiKey, imageFiles);
                // Create a comprehensive prompt for final recommendation
                const finalRecommendations = await getFinalRecommendations(apiKey, analyses);
                // Display final results
                resultDiv.innerHTML = `<h3>Overall Analysis:</h3><p>${finalRecommendations}</p>`;
            } catch (error) {
                handleAnalysisError(error, resultDiv);
            } finally {
                spinner.style.display = 'none';
            }
        }
        // Analyze a batch of step images
        async function analyzeSteps(apiKey, stepsArray) {
            const stepAnalyses = [];
            for (let i = 0; i < stepsArray.length; i++) {
                const imageData = stepsArray[i];
                try {
                    const analysis = await analyzeImage(
                        apiKey,
                        imageData.file,
                        `Imagine you are a friendly bowling coach helping a beginner. Analyze this bowling approach step. Explain what you see in simple, encouraging language. Point out what is done well, and gently mention any areas for improvement. Use analogies or tips if helpful, and keep the tone positive and supportive. Be specific about proper bowling form for this step, but avoid technical jargon.`
                    );
                    // Display individual step analysis
                    const stepAnalysisDiv = document.getElementById(`stepAnalysis${imageData.stepNumber}`);
                    if (stepAnalysisDiv) {
                        stepAnalysisDiv.textContent = analysis;
                        stepAnalysisDiv.style.display = 'block';
                    }
                    stepAnalyses.push({ stepNumber: imageData.stepNumber, analysis: analysis });
                } catch (stepError) {
                    const stepAnalysisDiv = document.getElementById(`stepAnalysis${imageData.stepNumber}`);
                    if (stepAnalysisDiv) {
                        stepAnalysisDiv.textContent = `Error analyzing this step: ${stepError.message}`;
                        stepAnalysisDiv.style.display = 'block';
                        stepAnalysisDiv.style.backgroundColor = '#ffebee';
                        stepAnalysisDiv.style.borderLeft = '3px solid #d32f2f';
                    }
                    stepAnalyses.push({ stepNumber: imageData.stepNumber, analysis: `[Error in analysis: ${stepError.message}]` });
                }
            }
            return stepAnalyses;
        }
        // Analyze a single image using Groq Vision API
        async function analyzeImage(apiKey, imageFile, promptText) {
            const imageBuffer = await imageFile.arrayBuffer();
            const base64Image = bufferToBase64(imageBuffer);
            const imageMediaType = imageFile.type || (imageFile.name.endsWith('.png') ? 'image/png' : 'image/jpeg');
            const payload = {
                messages: [
                    {
                        role: "user",
                        content: [
                            { type: "text", text: promptText },
                            {
                                type: "image_url",
                                image_url: {
                                    url: `data:${imageMediaType};base64,${base64Image}`,
                                },
                            },
                        ],
                    },
                ],
                model: "meta-llama/llama-4-scout-17b-16e-instruct",
                max_tokens: 1000
            };
            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload),
            });
            if (!response.ok) {
                let errorText = `HTTP error! status: ${response.status}`;
                try {
                    const errorData = await response.json();
                    if (errorData.error && typeof errorData.error === 'object') {
                        errorText = errorData.error.message || JSON.stringify(errorData.error);
                    } else if (errorData.error) {
                        errorText = String(errorData.error);
                    } else if (errorData.message) {
                        errorText = String(errorData.message);
                    } else {
                        errorText = JSON.stringify(errorData);
                    }
                } catch (e) {
                    errorText = response.statusText || errorText;
                }
                throw new Error(errorText);
            }
            const data = await response.json();
            if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                return data.choices[0].message.content;
            } else {
                throw new Error('Could not extract analysis from the response');
            }
        }
        // Get final recommendations using Groq Chat API
        async function getFinalRecommendations(apiKey, stepAnalyses) {
            let comprehensivePrompt = "You are a friendly, supportive bowling coach. Based on the following analyses of each step in a bowling approach, provide feedback and suggestions in simple, encouraging language. Use analogies, tips, and positive reinforcement. Avoid technical jargon.\n\n";
            stepAnalyses.forEach(sa => {
                comprehensivePrompt += `STEP ${sa.stepNumber}:\n${sa.analysis}\n\n`;
            });
            comprehensivePrompt += "Give specific, actionable recommendations to help the bowler improve, and finish with a motivating message.";
            const payload = {
                messages: [
                    {
                        role: "system",
                        content: "You are a professional bowling coach with expertise in analyzing bowling approaches. Provide detailed, actionable feedback based on the analyses provided. Use a friendly, supportive, and easy-to-understand tone."
                    },
                    {
                        role: "user",
                        content: comprehensivePrompt
                    }
                ],
                model: "meta-llama/llama-4-scout-17b-16e-instruct",
                max_tokens: 2000
            };
            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload),
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                return data.choices[0].message.content;
            } else {
                throw new Error('Could not extract recommendations from the response');
            }
        }
        // Helper function to convert ArrayBuffer to Base64
        function bufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }
        // Handle analysis errors
        function handleAnalysisError(error, resultDiv) {
            let errorMessage = '';
            if (error instanceof Error) {
                errorMessage = error.message;
                if (error.message.includes('JSON')) {
                    errorMessage = 'Error parsing API response. Please check your API key and try again.';
                } else if (error.message.includes('NetworkError') || error.message.includes('network')) {
                    errorMessage = 'Network error connecting to Groq API. Please check your internet connection.';
                } else if (error.message.includes('401') || error.message.includes('unauthorized')) {
                    errorMessage = 'Authorization failed. Please check your API key.';
                } else if (error.message.includes('404')) {
                    errorMessage = 'API endpoint not found (404). Make sure you\'re using the latest Groq API endpoint.';
                } else if (error.message.includes('model')) {
                    errorMessage = 'Model not found or not available. The Groq API may have updated their model names.';
                }
            } else if (typeof error === 'object' && error !== null) {
                errorMessage = 'Unexpected error: ' + JSON.stringify(error);
            } else {
                errorMessage = String(error);
            }
            resultDiv.innerHTML = `<div style="color: #d32f2f; background-color: #ffebee; padding: 15px; border-radius: 4px; border-left: 4px solid #d32f2f;">
                <h3>Error Analyzing Approach</h3>
                <p>${errorMessage}</p>
                <p>Check the browser console for more details (F12 > Console).</p>
                <p>If you're seeing 404 errors, check that you're using the correct API endpoint: 
                   <code>https://api.groq.com/openai/v1/chat/completions</code></p>
            </div>`;
        }
        // --- Swipe gesture support for step tab navigation ---
        let touchStartX = null;
        let touchEndX = null;
        function handleTouchStart(e) {
            if (e.touches && e.touches.length === 1) {
                touchStartX = e.touches[0].clientX;
            }
        }
        function handleTouchMove(e) {
            if (e.touches && e.touches.length === 1) {
                touchEndX = e.touches[0].clientX;
            }
        }
        function handleTouchEnd() {
            if (touchStartX !== null && touchEndX !== null) {
                const dx = touchEndX - touchStartX;
                if (Math.abs(dx) > 40) { // Minimum swipe distance
                    if (dx < 0 && currentStepTab < totalSteps) {
                        showStepTab(currentStepTab + 1); // Swipe left: next
                    } else if (dx > 0 && currentStepTab > 1) {
                        showStepTab(currentStepTab - 1); // Swipe right: previous
                    }
                }
            }
            touchStartX = null;
            touchEndX = null;
        }
        // Attach swipe listeners after tabs are generated
        function attachSwipeListeners() {
            const tabContent = document.getElementById('stepTabContent');
            tabContent.addEventListener('touchstart', handleTouchStart, {passive:true});
            tabContent.addEventListener('touchmove', handleTouchMove, {passive:true});
            tabContent.addEventListener('touchend', handleTouchEnd, {passive:true});
        }
        // --- Bulk image upload for all steps ---
document.addEventListener('DOMContentLoaded', function() {
    const bulkInput = document.getElementById('bulkImageUpload');
    if (bulkInput) {
        bulkInput.addEventListener('change', handleBulkImageUpload);
    }
});

function handleBulkImageUpload(e) {
    const files = Array.from(e.target.files || []);
    if (!files.length) return;
    // Set step count to number of images
    document.getElementById('stepCount').value = files.length;
    generateStepTabs();
    // Assign each image to the corresponding step input and preview
    setTimeout(() => {
        for (let i = 0; i < files.length; i++) {
            const fileInput = document.getElementById(`imageFile${i+1}`);
            if (fileInput) {
                // Create a DataTransfer to set the file input value
                const dt = new DataTransfer();
                dt.items.add(files[i]);
                fileInput.files = dt.files;
                // Preview the image
                previewImage(fileInput, i+1);
            }
        }
        checkAllImagesUploaded();
    }, 100); // Wait for DOM to update
}

// API key show/hide toggle
document.addEventListener('DOMContentLoaded', function() {
    const apiKeyInput = document.getElementById('apiKey');
    const toggleBtn = document.getElementById('toggleApiKeyBtn');
    if (apiKeyInput && toggleBtn) {
        let hidden = false;
        toggleBtn.addEventListener('click', function() {
            hidden = !hidden;
            apiKeyInput.type = hidden ? 'password' : 'text';
            toggleBtn.textContent = hidden ? '🙈' : '👁️';
            toggleBtn.setAttribute('aria-label', hidden ? 'Show API Key' : 'Hide API Key');
        });
        // Start with hidden
        apiKeyInput.type = 'password';
        toggleBtn.textContent = '🙈';
        toggleBtn.setAttribute('aria-label', 'Show API Key');
    }
    // API Key instructions toggle
    const showBtn = document.getElementById('showApiKeyInstructionsBtn');
    const instructions = document.getElementById('apiKeyInstructions');
    if (showBtn && instructions) {
        showBtn.addEventListener('click', function() {
            instructions.style.display = instructions.style.display === 'none' ? 'block' : 'none';
            showBtn.textContent = instructions.style.display === 'none' ? 'How to get Groq API Key?' : 'Hide API Key Instructions';
        });
    }
});
    </script>
</body>
</html>