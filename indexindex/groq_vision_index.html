<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Groq Image Analysis (Client-Side)</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f9; display: flex; flex-direction: column; align-items: center; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); width: 90%; max-width: 500px; }
        h1 { color: #333; text-align: center; }
        h2 { color: #555; margin-top: 20px; }
        input[type="file"], input[type="text"], button {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            width: calc(100% - 22px);
        }
        #apiKey, input[type="text"] {
            width: calc(100% - 22px);
            margin-bottom: 10px;
        }
        button { background-color: #007bff; color: white; cursor: pointer; border: none; }
        button:hover { background-color: #0056b3; }
        #result { margin-top: 10px; padding: 10px; border: 1px solid #eee; background-color: #f9f9f9; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; min-height: 50px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
            <input type="text" id="apiKey" placeholder="Enter your Groq API Key here">
        <h1>Groq Image Analysis (Client-Side)</h1>
        <div>
            <label for="apiKey">Groq API Key:</label>
            <input type="text" id="apiKey" placeholder="Enter your Groq API Key here">
        </div>
        <div>
            <label for="imageFile">Choose an image file:</label>
            <input type="file" id="imageFile" accept="image/*" aria-label="Image file selection" title="Select an image to analyze">
        </div>
        <input type="text" id="prompt" placeholder="Optional: Enter a prompt (e.g., What color is the car?)">
        <button onclick="analyzeImage()">Analyze Image</button>
        <div class="spinner" id="spinner"></div>
        <h2>Result:</h2>
        <pre id="result"></pre>
    </div>

    <script>
        async function analyzeImage() {
            const apiKey = document.getElementById('apiKey').value;
            const imageFile = document.getElementById('imageFile').files[0];
            const promptText = document.getElementById('prompt').value;
            const resultDiv = document.getElementById('result');
            const spinner = document.getElementById('spinner');

            if (!apiKey) {
                resultDiv.textContent = 'Please enter your Groq API Key.';
                return;
            }
            if (!imageFile) {
                resultDiv.textContent = 'Please select an image file.';
                return;
            }

            resultDiv.textContent = '';
            spinner.style.display = 'block';

            const formData = new FormData();
            formData.append('image', imageFile); // This FormData will not be used for JSON payload
            // We need to construct the JSON payload manually as per Groq's spec for chat completions with images

            const imageBuffer = await imageFile.arrayBuffer();
            const base64Image = bufferToBase64(imageBuffer);
            const imageMediaType = imageFile.type || (imageFile.name.endsWith('.png') ? 'image/png' : 'image/jpeg');


            const payload = {
              messages: [
                {
                  role: "user",
                  content: [
                    { type: "text", text: promptText || "What's in this image?" },
                    {
                      type: "image_url",
                      image_url: {
                        url: `data:${imageMediaType};base64,${base64Image}`,
                      },
                    },
                  ],
                },
              ],
              model: "meta-llama/llama-4-scout-17b-16e-instruct", // Or make this configurable
            };

            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload),
                });

                spinner.style.display = 'none';

                if (!response.ok) {
                    let errorText = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorText = errorData.error || errorData.message || JSON.stringify(errorData);
                    } catch (e) {
                        // If response is not JSON, use the status text
                        errorText = response.statusText || errorText;
                    }
                    throw new Error(errorText);
                }

                const data = await response.json();
                if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                    resultDiv.textContent = data.choices[0].message.content;
                } else {
                    resultDiv.textContent = 'Could not extract analysis from the response. Raw response: ' + JSON.stringify(data, null, 2);
                }
            } catch (error) {
                spinner.style.display = 'none';
                console.error('Error analyzing image:', error);
                resultDiv.textContent = 'Error: ' + error.message;
            }
        }

        // Helper function to convert ArrayBuffer to Base64
        function bufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }
    </script>
</body>
</html>
